<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>STL Assembly Viewer with Group Colors</title>
  <style>
    html, body { margin: 0; overflow: hidden; font-family: sans-serif; background: #111; color: #eee; }
    canvas { display: block; }
    #ui {
      position: fixed; top: 10px; left: 10px; z-index: 1;
      background: #222; padding: 12px; border-radius: 8px; max-height: 95vh; overflow-y: auto;
    }
    button, select {
      background: #444; color: #fff; border: 1px solid #666; padding: 6px; margin: 4px 0;
    }
    #group-color-dropdown {
      width: 100%; padding: 6px; margin: 6px 0;
    }
  </style>
</head>
<body>
  <div id="ui">
    <input type="file" id="file-input" multiple accept=".stl" />
    <div>
      <select id="group-selector">
        <option value="">Select Group</option>
      </select>
      <select id="group-color-dropdown">
        <option value="">Pick Color</option>
      </select>
      <button id="apply-group-color-btn">Apply to Group</button>
      <button onclick="randomizeGroupColors()">ðŸŽ² Randomize Group Colors</button>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/DragControls.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/STLLoader.js"></script>
  <script>
    let scene, camera, renderer, controls, dragControls;
    let parts = [], groups = [], selectedGroup = null;
    let animationFrameId = null;

    const presetColors = ['#e6194b','#3cb44b','#ffe119','#4363d8','#f58231','#911eb4','#46f0f0','#f032e6'];

    init();
    animate();

    function init() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 1000);
      camera.position.set(100, 100, 100);

      renderer = new THREE.WebGLRenderer({antialias: true});
      renderer.setSize(window.innerWidth, window.innerHeight);
      document.body.appendChild(renderer.domElement);

      controls = new THREE.OrbitControls(camera, renderer.domElement);

      document.getElementById('file-input').addEventListener('change', handleFiles);
      document.getElementById('group-selector').addEventListener('change', e => {
        selectedGroup = groups[e.target.value];
      });
      document.getElementById('group-color-dropdown').addEventListener('change', updateGroupColorDisplay);
      document.getElementById('apply-group-color-btn').addEventListener('click', applyColorToGroup);

      populateColorDropdown();
      window.addEventListener('resize', onWindowResize);
    }

    function onWindowResize() {
      camera.aspect = window.innerWidth/window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function populateColorDropdown() {
      const dropdown = document.getElementById('group-color-dropdown');
      presetColors.forEach(color => {
        const opt = document.createElement('option');
        opt.value = color;
        opt.textContent = color;
        opt.style.background = color;
        dropdown.appendChild(opt);
      });
    }

    function updateGroupColorDisplay() {
      const color = document.getElementById('group-color-dropdown').value;
      const btn = document.getElementById('apply-group-color-btn');
      if (selectedGroup && color) {
        btn.textContent = `Apply ${color} to ${selectedGroup.name}`;
        btn.style.background = color;
        btn.style.color = '#fff';
      }
    }

    function animate() {
      animationFrameId = requestAnimationFrame(animate);
      controls.update();
      renderer.render(scene, camera);
    }

    function stopAnimation() {
      if (animationFrameId) cancelAnimationFrame(animationFrameId);
    }

    function clearScene() {
      parts.forEach(mesh => {
        mesh.geometry.dispose();
        if (mesh.material.map) mesh.material.map.dispose();
        mesh.material.dispose();
        scene.remove(mesh);
      });
      parts = [];
      if (dragControls) {
        dragControls.deactivate();
        dragControls = null;
      }
    }

    function handleFiles(event) {
      clearScene();
      const loader = new THREE.STLLoader();
      const files = Array.from(event.target.files);

      files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = e => {
          const geom = loader.parse(e.target.result);
          const mat = new THREE.MeshStandardMaterial({color: 0xaaaaaa});
          const mesh = new THREE.Mesh(geom, mat);
          mesh.position.x = index * 30;
          scene.add(mesh);
          parts.push(mesh);
        };
        reader.readAsArrayBuffer(file);
      });

      // Example: create default group from all
      groups.push({ name: "All Parts", parts: new Set(files.map((_, i) => i)), color: '#aaaaaa' });
      renderGroupSelector();

      dragControls = new THREE.DragControls(parts, camera, renderer.domElement);
    }

    function renderGroupSelector() {
      const sel = document.getElementById('group-selector');
      sel.innerHTML = '<option value="">Select Group</option>';
      groups.forEach((g, i) => {
        const opt = document.createElement('option');
        opt.value = i;
        opt.textContent = `${g.name}`;
        opt.style.color = g.color || '#fff';
        sel.appendChild(opt);
      });
    }

    function applyColorToGroup() {
      if (!selectedGroup) return;
      const color = document.getElementById('group-color-dropdown').value;
      selectedGroup.color = color;
      selectedGroup.parts.forEach(idx => {
        const mesh = parts[idx];
        if (mesh) {
          mesh.material.color.set(color);
        }
      });
      renderGroupSelector();
    }

    function randomizeGroupColors() {
      groups.forEach(group => {
        const color = presetColors[Math.floor(Math.random() * presetColors.length)];
        group.color = color;
        group.parts.forEach(idx => {
          parts[idx].material.color.set(color);
        });
      });
      renderGroupSelector();
    }
  </script>
</body>
</html>
